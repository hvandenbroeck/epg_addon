<!DOCTYPE html>
<html>
<head>
    <title>Energy Optimizer</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" onclick="switchTab('dashboard')">Dashboard</button>
        <button class="tab-button" onclick="switchTab('debug')">Debug Logs</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content active">
    <div class="peak-display">
        <div class="peak-label">Current Power Peak</div>
        <div class="peak-value" id="peakValue">-- kW</div>
        <div class="peak-label" style="margin-top: 5px; font-size: 14px; color: #999;">Time Slot: <span id="slotInfo">--</span></div>
        <div class="peak-label" style="margin-top: 20px;">Available Power</div>
        <div class="peak-value" id="availablePower" style="color: #28a745;">-- kW</div>
        <div class="peak-label" style="margin-top: 10px; font-size: 14px;">Max Peak: <span id="maxPeak">--</span> kW</div>
        <div class="peak-timestamp" id="peakTimestamp">Loading...</div>
    </div>
    <div class="battery-thresholds">
        <h2>Battery Price Thresholds</h2>
        <div id="batteryThresholdsContent">
            <div class="loading">Loading thresholds...</div>
        </div>
    </div>
    <div class="device-limits">
        <h2>Device Load Limits</h2>
        <div id="deviceLimitsContent">
            <div class="loading">Loading device limits...</div>
        </div>
    </div>
    <div id="timeline">
        <div class="loading">Loading schedule...</div>
    </div>
    <div class="links">
        <a href="download/tomorrow_features.csv" download>Download tomorrow_features.csv</a>
        <a href="download/merged_historical_data.csv" download>Download merged_historical_data.csv</a>
        <a href="download/entsoe_raw_prices.csv" download>Download entsoe_raw_prices.csv</a>
        <a href="download/entsoe_resampled_prices.csv" download>Download entsoe_resampled_prices.csv</a>
    </div>
    </div>
    <!-- End Dashboard Tab -->

    <!-- Debug Logs Tab -->
    <div id="debug-tab" class="tab-content">
        <div class="debug-container">
            <div class="debug-header">
                <h2>Debug Logs</h2>
                <div class="debug-controls">
                    <div class="filter-group">
                        <label for="levelFilter">Level:</label>
                        <select id="levelFilter" onchange="updateLogs()">
                            <option value="">All Levels</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="moduleFilter">Module:</label>
                        <select id="moduleFilter" onchange="updateLogs()">
                            <option value="">All Modules</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="searchFilter">Search:</label>
                        <input type="text" id="searchFilter" placeholder="Search logs..." onkeyup="filterLogsClientSide()">
                    </div>
                    <div class="filter-group">
                        <button onclick="updateLogs()" class="btn-refresh">üîÑ Refresh</button>
                        <button onclick="clearLogs()" class="btn-clear">üóëÔ∏è Clear All</button>
                        <button onclick="toggleAutoRefresh()" class="btn-auto" id="autoRefreshBtn">‚è∏Ô∏è Auto-Refresh: ON</button>
                    </div>
                </div>
            </div>
            <div class="log-stats" id="logStats">Loading...</div>
            <div class="log-container" id="logContainer">
                <div class="loading">Loading logs...</div>
            </div>
            <div class="log-pagination">
                <button onclick="loadMoreLogs()" id="loadMoreBtn">Load More</button>
                <span id="logCount">0 logs displayed</span>
            </div>
        </div>
    </div>
    <!-- End Debug Logs Tab -->

    <script>
        let currentTab = 'dashboard';
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;
        let currentOffset = 0;
        let allLogs = [];

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Load data for the tab
            if (tabName === 'debug') {
                updateLogs();
                if (autoRefreshEnabled && !autoRefreshInterval) {
                    autoRefreshInterval = setInterval(updateLogs, 10000); // Refresh every 10 seconds
                }
            } else {
                // Stop auto-refresh when leaving debug tab
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshEnabled) {
                btn.textContent = '‚è∏Ô∏è Auto-Refresh: ON';
                btn.classList.remove('btn-off');
                if (currentTab === 'debug') {
                    autoRefreshInterval = setInterval(updateLogs, 10000);
                }
            } else {
                btn.textContent = '‚ñ∂Ô∏è Auto-Refresh: OFF';
                btn.classList.add('btn-off');
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        function updateLogs(append = false) {
            const level = document.getElementById('levelFilter').value;
            const module = document.getElementById('moduleFilter').value;
            const offset = append ? currentOffset : 0;
            
            let url = `api/logs?limit=100&offset=${offset}`;
            if (level) url += `&level=${level}`;
            if (module) url += `&module=${module}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!append) {
                        allLogs = data.logs;
                        currentOffset = data.logs.length;
                    } else {
                        allLogs = allLogs.concat(data.logs);
                        currentOffset += data.logs.length;
                    }
                    
                    // Update module filter options
                    const moduleFilter = document.getElementById('moduleFilter');
                    const currentModule = moduleFilter.value;
                    moduleFilter.innerHTML = '<option value="">All Modules</option>';
                    data.unique_modules.forEach(mod => {
                        if (mod) {
                            const option = document.createElement('option');
                            option.value = mod;
                            option.textContent = mod;
                            if (mod === currentModule) option.selected = true;
                            moduleFilter.appendChild(option);
                        }
                    });
                    
                    // Update stats
                    const stats = document.getElementById('logStats');
                    const levelCounts = {};
                    allLogs.forEach(log => {
                        levelCounts[log.level] = (levelCounts[log.level] || 0) + 1;
                    });
                    stats.innerHTML = `
                        <span class="stat-item">Total: <strong>${data.total}</strong></span>
                        ${Object.entries(levelCounts).map(([lvl, count]) => 
                            `<span class="stat-item stat-${lvl.toLowerCase()}">${lvl}: <strong>${count}</strong></span>`
                        ).join('')}
                    `;
                    
                    // Display logs
                    displayLogs(allLogs);
                    
                    // Update load more button
                    const loadMoreBtn = document.getElementById('loadMoreBtn');
                    if (currentOffset >= data.total) {
                        loadMoreBtn.style.display = 'none';
                    } else {
                        loadMoreBtn.style.display = 'inline-block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching logs:', error);
                    document.getElementById('logContainer').innerHTML = 
                        '<div class="log-error">Error loading logs</div>';
                });
        }

        function displayLogs(logs) {
            const container = document.getElementById('logContainer');
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            
            // Filter by search term on client side
            let filteredLogs = logs;
            if (searchTerm) {
                filteredLogs = logs.filter(log => 
                    log.message.toLowerCase().includes(searchTerm) ||
                    log.module.toLowerCase().includes(searchTerm) ||
                    log.filename.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredLogs.length === 0) {
                container.innerHTML = '<div class="no-logs">No logs match the current filters</div>';
                document.getElementById('logCount').textContent = '0 logs displayed';
                return;
            }
            
            let html = '<table class="log-table"><thead><tr>' +
                '<th>Time</th><th>Level</th><th>Module</th><th>Function</th><th>Line</th><th>Message</th>' +
                '</tr></thead><tbody>';
            
            filteredLogs.forEach(log => {
                const timestamp = new Date(log.timestamp);
                const timeStr = timestamp.toLocaleString();
                const levelClass = `log-level-${log.level.toLowerCase()}`;
                
                html += `
                    <tr class="${levelClass}">
                        <td class="log-time">${timeStr}</td>
                        <td class="log-level"><span class="level-badge level-${log.level.toLowerCase()}">${log.level}</span></td>
                        <td class="log-module" title="${log.filename}">${log.module}</td>
                        <td class="log-func">${log.funcName}</td>
                        <td class="log-line">${log.lineno}</td>
                        <td class="log-message">${escapeHtml(log.message)}</td>
                    </tr>
                `;
                
                // Add exception info if present
                if (log.exc_info) {
                    html += `
                        <tr class="log-exception">
                            <td colspan="6"><pre>${escapeHtml(log.exc_info)}</pre></td>
                        </tr>
                    `;
                }
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            document.getElementById('logCount').textContent = `${filteredLogs.length} logs displayed`;
        }

        function filterLogsClientSide() {
            displayLogs(allLogs);
        }

        function loadMoreLogs() {
            updateLogs(true);
        }

        function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs? This cannot be undone.')) {
                return;
            }
            
            fetch('api/logs/clear', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert('All logs cleared');
                    updateLogs();
                })
                .catch(error => {
                    console.error('Error clearing logs:', error);
                    alert('Error clearing logs');
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updatePeak() {
            fetch('api/peak')
                .then(response => response.json())
                .then(data => {
                    const peakKw = data.peak_kw || 0;
                    const timestamp = data.timestamp || '';
                    const maxPeakKw = data.max_peak_kw || 7.5;
                    const availablePowerKw = data.available_power_kw || 0;
                    const slotStart = data.slot_start || '';
                    const slotReadingsCount = data.slot_readings_count || 0;
                    const peakCalcMinutes = data.peak_calculation_minutes || 15;
                    
                    document.getElementById('peakValue').textContent = 
                        peakKw.toFixed(2) + ' kW';
                    
                    document.getElementById('availablePower').textContent = 
                        availablePowerKw.toFixed(2) + ' kW';
                    
                    document.getElementById('maxPeak').textContent = 
                        maxPeakKw.toFixed(1);
                    
                    // Display slot information
                    if (slotStart) {
                        const slotStartDate = new Date(slotStart);
                        const slotEndDate = new Date(slotStartDate.getTime() + peakCalcMinutes * 60 * 1000);
                        const slotStartTime = slotStartDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const slotEndTime = slotEndDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        document.getElementById('slotInfo').textContent = 
                            `${slotStartTime} - ${slotEndTime} (${slotReadingsCount} readings)`;
                    } else {
                        document.getElementById('slotInfo').textContent = '--';
                    }
                    
                    // Color code available power (green if positive, red if negative)
                    const availableElement = document.getElementById('availablePower');
                    availableElement.style.color = availablePowerKw >= 0 ? '#28a745' : '#dc3545';
                    
                    if (timestamp) {
                        const date = new Date(timestamp);
                        document.getElementById('peakTimestamp').textContent = 
                            'Last updated: ' + date.toLocaleString();
                    } else {
                        document.getElementById('peakTimestamp').textContent = 
                            'Waiting for first measurement...';
                    }
                })
                .catch(error => {
                    console.error('Error fetching peak:', error);
                    document.getElementById('peakValue').textContent = '-- kW';
                    document.getElementById('availablePower').textContent = '-- kW';
                    document.getElementById('maxPeak').textContent = '--';
                    document.getElementById('slotInfo').textContent = '--';
                    document.getElementById('peakTimestamp').textContent = 
                        'Error loading peak data';
                });
        }

        function updateDeviceLimits() {
            fetch('api/device_limits')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('deviceLimitsContent');
                    const limits = data.limits || {};
                    const timestamp = data.timestamp || '';
                    const availablePowerWatts = data.available_power_watts || 0;
                    
                    if (Object.keys(limits).length === 0) {
                        container.innerHTML = '<div class="no-limits">No device limits calculated yet</div>';
                        return;
                    }
                    
                    let html = '<div class="device-grid">';
                    
                    // Sort devices by priority
                    const sortedDevices = Object.entries(limits).sort((a, b) => 
                        a[1].priority - b[1].priority
                    );
                    
                    sortedDevices.forEach(([deviceName, deviceData]) => {
                        const currentLoad = deviceData.current_load_watts || 0;
                        const limitWatts = deviceData.limit_watts || 0;
                        const maxWatts = deviceData.max_watts || 0;
                        const priority = deviceData.priority || 0;
                        const state = deviceData.state || 'Unknown';
                        
                        // Calculate percentage for visual bar
                        const percentage = maxWatts > 0 ? (limitWatts / maxWatts * 100) : 0;
                        
                        // Format device name
                        const displayName = deviceName.replace(/_/g, ' ').toUpperCase();
                        
                        // State badge color
                        let stateBadgeColor = '#999';
                        if (state === 'Not charging') {
                            stateBadgeColor = '#6c757d';  // Gray
                        } else if (state === 'Charging below limit') {
                            stateBadgeColor = '#28a745';  // Green
                        } else if (state === 'Limit enforced') {
                            stateBadgeColor = '#ffc107';  // Yellow/Orange
                        }
                        
                        html += `
                            <div class="device-card">
                                <div class="device-name">
                                    ${displayName}
                                    <span class="priority-badge">P${priority}</span>
                                </div>
                                <div class="device-stat">
                                    <span class="device-stat-label">Status:</span>
                                    <span class="device-stat-value" style="color: ${stateBadgeColor}; font-weight: bold;">${state}</span>
                                </div>
                                <div class="device-stat">
                                    <span class="device-stat-label">Current Load:</span>
                                    <span class="device-stat-value">${currentLoad.toFixed(0)} W</span>
                                </div>
                                <div class="device-stat">
                                    <span class="device-stat-label">New Limit:</span>
                                    <span class="device-stat-value" style="color: #0066cc;">${limitWatts.toFixed(0)} W</span>
                                </div>
                                <div class="device-stat">
                                    <span class="device-stat-label">Max Capacity:</span>
                                    <span class="device-stat-value">${maxWatts.toFixed(0)} W</span>
                                </div>
                                <div class="limit-bar">
                                    <div class="limit-fill" style="width: ${percentage.toFixed(1)}%"></div>
                                    <div class="limit-text">${percentage.toFixed(0)}% of max</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                    // Add timestamp and available power info
                    if (timestamp) {
                        const date = new Date(timestamp);
                        const powerStatus = availablePowerWatts >= 0 ? 
                            `<span style="color: #28a745;">+${availablePowerWatts.toFixed(0)} W available</span>` :
                            `<span style="color: #dc3545;">${availablePowerWatts.toFixed(0)} W excess</span>`;
                        html += `<div style="text-align: center; margin-top: 15px; font-size: 12px; color: #999;">
                            Last updated: ${date.toLocaleString()} | Power: ${powerStatus}
                        </div>`;
                    }
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching device limits:', error);
                    document.getElementById('deviceLimitsContent').innerHTML = 
                        '<div class="no-limits">Error loading device limits</div>';
                });
        }

        function updateBatteryThresholds() {
            fetch('api/battery_thresholds')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('batteryThresholdsContent');
                    
                    if (!data.max_charge_price && !data.min_discharge_price) {
                        container.innerHTML = '<div class="no-limits">No battery thresholds calculated yet</div>';
                        return;
                    }
                    
                    const maxCharge = data.max_charge_price !== null ? data.max_charge_price.toFixed(4) : '--';
                    const minDischarge = data.min_discharge_price !== null ? data.min_discharge_price.toFixed(4) : '--';
                    const historyDays = data.price_history_days || '--';
                    const chargePercentile = data.charge_percentile || '--';
                    const dischargePercentile = data.discharge_percentile || '--';
                    const priceDiff = data.price_diff_threshold !== null ? data.price_diff_threshold.toFixed(4) : '--';
                    
                    let html = `
                        <div class="threshold-grid">
                            <div class="threshold-card charge">
                                <div class="threshold-title">Max Charge Price</div>
                                <div class="threshold-value">‚Ç¨${maxCharge}/kWh</div>
                                <div class="threshold-detail">‚â§ ${chargePercentile}th percentile</div>
                            </div>
                            <div class="threshold-card discharge">
                                <div class="threshold-title">Min Discharge Price</div>
                                <div class="threshold-value">‚Ç¨${minDischarge}/kWh</div>
                                <div class="threshold-detail">‚â• ${dischargePercentile}th percentile</div>
                            </div>
                        </div>
                        <div class="threshold-info">
                            Based on ${historyDays} days of price history | Price diff threshold: ‚Ç¨${priceDiff}/kWh
                        </div>
                    `;
                    
                    if (data.updated_at) {
                        const date = new Date(data.updated_at);
                        html += `<div class="threshold-timestamp">Last updated: ${date.toLocaleString()}</div>`;
                    }
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching battery thresholds:', error);
                    document.getElementById('batteryThresholdsContent').innerHTML = 
                        '<div class="no-limits">Error loading battery thresholds</div>';
                });
        }

        function updateChart() {
            fetch('api/gantt')
                .then(response => response.text())
                .then(html => {
                    const container = document.getElementById('timeline');
                    container.innerHTML = html;
                    
                    // Execute scripts in the inserted HTML
                    const scripts = container.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        if (script.src) {
                            newScript.src = script.src;
                        } else {
                            newScript.textContent = script.textContent;
                        }
                        document.body.appendChild(newScript);
                    });
                })
                .catch(error => {
                    console.error('Error fetching chart:', error);
                    document.getElementById('timeline').innerHTML = 
                        '<div class="loading">Error loading schedule</div>';
                });
        }

        // Update on load
        updatePeak();
        updateDeviceLimits();
        updateBatteryThresholds();
        updateChart();
        
        // Update peak and device limits every 30 seconds, chart every minute
        setInterval(updatePeak, 30000);
        setInterval(updateDeviceLimits, 30000);
        setInterval(updateBatteryThresholds, 60000);
        setInterval(updateChart, 60000);
    </script>
</body>
</html>