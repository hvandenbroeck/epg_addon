<!DOCTYPE html>
<html>
<head>
    <title>Energy Optimizer</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="peak-display">
        <div class="peak-label">Current Power Peak</div>
        <div class="peak-value" id="peakValue">-- kW</div>
        <div class="peak-label" style="margin-top: 5px; font-size: 14px; color: #999;">Time Slot: <span id="slotInfo">--</span></div>
        <div class="peak-label" style="margin-top: 20px;">Available Power</div>
        <div class="peak-value" id="availablePower" style="color: #28a745;">-- kW</div>
        <div class="peak-label" style="margin-top: 10px; font-size: 14px;">Max Peak: <span id="maxPeak">--</span> kW</div>
        <div class="peak-timestamp" id="peakTimestamp">Loading...</div>
    </div>
    <div class="device-limits">
        <h2>Device Load Limits</h2>
        <div id="deviceLimitsContent">
            <div class="loading">Loading device limits...</div>
        </div>
    </div>
    <div id="timeline">
        <div class="loading">Loading schedule...</div>
    </div>
    <div class="links">
        <a href="download/tomorrow_features.csv" download>Download tomorrow_features.csv</a>
        <a href="download/merged_historical_data.csv" download>Download merged_historical_data.csv</a>
        <a href="download/entsoe_raw_prices.csv" download>Download entsoe_raw_prices.csv</a>
        <a href="download/entsoe_resampled_prices.csv" download>Download entsoe_resampled_prices.csv</a>
    </div>
    <script>
        function updatePeak() {
            fetch('api/peak')
                .then(response => response.json())
                .then(data => {
                    const peakKw = data.peak_kw || 0;
                    const timestamp = data.timestamp || '';
                    const maxPeakKw = data.max_peak_kw || 7.5;
                    const availablePowerKw = data.available_power_kw || 0;
                    const slotStart = data.slot_start || '';
                    const slotReadingsCount = data.slot_readings_count || 0;
                    const peakCalcMinutes = data.peak_calculation_minutes || 15;
                    
                    document.getElementById('peakValue').textContent = 
                        peakKw.toFixed(2) + ' kW';
                    
                    document.getElementById('availablePower').textContent = 
                        availablePowerKw.toFixed(2) + ' kW';
                    
                    document.getElementById('maxPeak').textContent = 
                        maxPeakKw.toFixed(1);
                    
                    // Display slot information
                    if (slotStart) {
                        const slotStartDate = new Date(slotStart);
                        const slotEndDate = new Date(slotStartDate.getTime() + peakCalcMinutes * 60 * 1000);
                        const slotStartTime = slotStartDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const slotEndTime = slotEndDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        document.getElementById('slotInfo').textContent = 
                            `${slotStartTime} - ${slotEndTime} (${slotReadingsCount} readings)`;
                    } else {
                        document.getElementById('slotInfo').textContent = '--';
                    }
                    
                    // Color code available power (green if positive, red if negative)
                    const availableElement = document.getElementById('availablePower');
                    availableElement.style.color = availablePowerKw >= 0 ? '#28a745' : '#dc3545';
                    
                    if (timestamp) {
                        const date = new Date(timestamp);
                        document.getElementById('peakTimestamp').textContent = 
                            'Last updated: ' + date.toLocaleString();
                    } else {
                        document.getElementById('peakTimestamp').textContent = 
                            'Waiting for first measurement...';
                    }
                })
                .catch(error => {
                    console.error('Error fetching peak:', error);
                    document.getElementById('peakValue').textContent = '-- kW';
                    document.getElementById('availablePower').textContent = '-- kW';
                    document.getElementById('maxPeak').textContent = '--';
                    document.getElementById('slotInfo').textContent = '--';
                    document.getElementById('peakTimestamp').textContent = 
                        'Error loading peak data';
                });
        }

        function updateDeviceLimits() {
            fetch('api/device_limits')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('deviceLimitsContent');
                    const limits = data.limits || {};
                    const timestamp = data.timestamp || '';
                    const availablePowerWatts = data.available_power_watts || 0;
                    
                    if (Object.keys(limits).length === 0) {
                        container.innerHTML = '<div class="no-limits">No device limits calculated yet</div>';
                        return;
                    }
                    
                    let html = '<div class="device-grid">';
                    
                    // Sort devices by priority
                    const sortedDevices = Object.entries(limits).sort((a, b) => 
                        a[1].priority - b[1].priority
                    );
                    
                    sortedDevices.forEach(([deviceName, deviceData]) => {
                        const currentLoad = deviceData.current_load_watts || 0;
                        const limitWatts = deviceData.limit_watts || 0;
                        const maxWatts = deviceData.max_watts || 0;
                        const priority = deviceData.priority || 0;
                        const state = deviceData.state || 'Unknown';
                        
                        // Calculate percentage for visual bar
                        const percentage = maxWatts > 0 ? (limitWatts / maxWatts * 100) : 0;
                        
                        // Format device name
                        const displayName = deviceName.replace(/_/g, ' ').toUpperCase();
                        
                        // State badge color
                        let stateBadgeColor = '#999';
                        if (state === 'Not charging') {
                            stateBadgeColor = '#6c757d';  // Gray
                        } else if (state === 'Charging below limit') {
                            stateBadgeColor = '#28a745';  // Green
                        } else if (state === 'Limit enforced') {
                            stateBadgeColor = '#ffc107';  // Yellow/Orange
                        }
                        
                        html += `
                            <div class="device-card">
                                <div class="device-name">
                                    ${displayName}
                                    <span class="priority-badge">P${priority}</span>
                                </div>
                                <div class="device-stat">
                                    <span class="device-stat-label">Status:</span>
                                    <span class="device-stat-value" style="color: ${stateBadgeColor}; font-weight: bold;">${state}</span>
                                </div>
                                <div class="device-stat">
                                    <span class="device-stat-label">Current Load:</span>
                                    <span class="device-stat-value">${currentLoad.toFixed(0)} W</span>
                                </div>
                                <div class="device-stat">
                                    <span class="device-stat-label">New Limit:</span>
                                    <span class="device-stat-value" style="color: #0066cc;">${limitWatts.toFixed(0)} W</span>
                                </div>
                                <div class="device-stat">
                                    <span class="device-stat-label">Max Capacity:</span>
                                    <span class="device-stat-value">${maxWatts.toFixed(0)} W</span>
                                </div>
                                <div class="limit-bar">
                                    <div class="limit-fill" style="width: ${percentage.toFixed(1)}%"></div>
                                    <div class="limit-text">${percentage.toFixed(0)}% of max</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                    // Add timestamp and available power info
                    if (timestamp) {
                        const date = new Date(timestamp);
                        const powerStatus = availablePowerWatts >= 0 ? 
                            `<span style="color: #28a745;">+${availablePowerWatts.toFixed(0)} W available</span>` :
                            `<span style="color: #dc3545;">${availablePowerWatts.toFixed(0)} W excess</span>`;
                        html += `<div style="text-align: center; margin-top: 15px; font-size: 12px; color: #999;">
                            Last updated: ${date.toLocaleString()} | Power: ${powerStatus}
                        </div>`;
                    }
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching device limits:', error);
                    document.getElementById('deviceLimitsContent').innerHTML = 
                        '<div class="no-limits">Error loading device limits</div>';
                });
        }

        function updateChart() {
            fetch('api/gantt')
                .then(response => response.text())
                .then(html => {
                    const container = document.getElementById('timeline');
                    container.innerHTML = html;
                    
                    // Execute scripts in the inserted HTML
                    const scripts = container.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        if (script.src) {
                            newScript.src = script.src;
                        } else {
                            newScript.textContent = script.textContent;
                        }
                        document.body.appendChild(newScript);
                    });
                })
                .catch(error => {
                    console.error('Error fetching chart:', error);
                    document.getElementById('timeline').innerHTML = 
                        '<div class="loading">Error loading schedule</div>';
                });
        }

        // Update on load
        updatePeak();
        updateDeviceLimits();
        updateChart();
        
        // Update peak and device limits every 30 seconds, chart every minute
        setInterval(updatePeak, 30000);
        setInterval(updateDeviceLimits, 30000);
        setInterval(updateChart, 60000);
    </script>
</body>
</html>