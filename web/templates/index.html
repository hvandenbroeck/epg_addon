<!DOCTYPE html>
<html>
<head>
    <title>Energy Optimizer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .peak-display {
            max-width: 1400px;
            margin: 0 auto 20px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .peak-value {
            font-size: 48px;
            font-weight: bold;
            color: #0066cc;
            margin: 10px 0;
        }
        .peak-label {
            font-size: 18px;
            color: #666;
            margin-bottom: 5px;
        }
        .peak-timestamp {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        #timeline {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .links {
            margin: 20px auto;
            max-width: 1400px;
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .links a {
            color: #0066cc;
            text-decoration: none;
            margin: 0 10px;
            padding: 8px 15px;
            border: 1px solid #0066cc;
            border-radius: 4px;
            display: inline-block;
        }
        .links a:hover {
            background-color: #0066cc;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="peak-display">
        <div class="peak-label">Current Power Peak</div>
        <div class="peak-value" id="peakValue">-- kW</div>
        <div class="peak-label" style="margin-top: 20px;">Available Power</div>
        <div class="peak-value" id="availablePower" style="color: #28a745;">-- kW</div>
        <div class="peak-label" style="margin-top: 10px; font-size: 14px;">Max Peak: <span id="maxPeak">--</span> kW</div>
        <div class="peak-timestamp" id="peakTimestamp">Loading...</div>
    </div>
    <div id="timeline">
        <div class="loading">Loading schedule...</div>
    </div>
    <div class="links">
        <a href="download/tomorrow_features.csv" download>Download tomorrow_features.csv</a>
        <a href="download/features.csv" download>Download features.csv</a>
    </div>
    <script>
        function updatePeak() {
            fetch('api/peak')
                .then(response => response.json())
                .then(data => {
                    const peakKw = data.peak_kw || 0;
                    const timestamp = data.timestamp || '';
                    const maxPeakKw = data.max_peak_kw || 7.5;
                    const availablePowerKw = data.available_power_kw || 0;
                    
                    document.getElementById('peakValue').textContent = 
                        peakKw.toFixed(2) + ' kW';
                    
                    document.getElementById('availablePower').textContent = 
                        availablePowerKw.toFixed(2) + ' kW';
                    
                    document.getElementById('maxPeak').textContent = 
                        maxPeakKw.toFixed(1);
                    
                    // Color code available power (green if positive, red if negative)
                    const availableElement = document.getElementById('availablePower');
                    availableElement.style.color = availablePowerKw >= 0 ? '#28a745' : '#dc3545';
                    
                    if (timestamp) {
                        const date = new Date(timestamp);
                        document.getElementById('peakTimestamp').textContent = 
                            'Last updated: ' + date.toLocaleString();
                    } else {
                        document.getElementById('peakTimestamp').textContent = 
                            'Waiting for first measurement...';
                    }
                })
                .catch(error => {
                    console.error('Error fetching peak:', error);
                    document.getElementById('peakValue').textContent = '-- kW';
                    document.getElementById('availablePower').textContent = '-- kW';
                    document.getElementById('maxPeak').textContent = '--';
                    document.getElementById('peakTimestamp').textContent = 
                        'Error loading peak data';
                });
        }

        function updateChart() {
            fetch('api/gantt')
                .then(response => response.text())
                .then(html => {
                    const container = document.getElementById('timeline');
                    container.innerHTML = html;
                    
                    // Execute scripts in the inserted HTML
                    const scripts = container.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        if (script.src) {
                            newScript.src = script.src;
                        } else {
                            newScript.textContent = script.textContent;
                        }
                        document.body.appendChild(newScript);
                    });
                })
                .catch(error => {
                    console.error('Error fetching chart:', error);
                    document.getElementById('timeline').innerHTML = 
                        '<div class="loading">Error loading schedule</div>';
                });
        }

        // Update on load
        updatePeak();
        updateChart();
        
        // Update peak every 30 seconds, chart every minute
        setInterval(updatePeak, 30000);
        setInterval(updateChart, 60000);
    </script>
</body>
</html>